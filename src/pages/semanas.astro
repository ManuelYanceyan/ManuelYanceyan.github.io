---
import BaseLayout from '../layouts/BaseLayout.astro';
import SemanaList from '../components/SemanaList';
import { getCollection } from 'astro:content';
import { marked } from 'marked';

const title = "Reportes Semanales";

// obtener semanas desde contenido
const semanas = await getCollection('semanas');
const sortedSemanas = semanas.sort((a, b) => a.data.week - b.data.week);
const semanasData = sortedSemanas.map((semana) => {
  let html = marked.parse(semana.body);
  // Ensure image paths reference the `public/imagenes` folder so they render both in dev and production
  // Preserve the original quote char around src attribute
  html = html.replace(/src=(['"])\.\/imagenes\//g, 'src=$1/imagenes/');
  const text = html.replace(/<[^>]+>/g, "").replace(/\s+/g, " ").trim();
  const excerpt = text.slice(0, 160) + (text.length > 160 ? "..." : "");
  return {
    week: semana.data.week,
    title: semana.data.title,
    content: html,
    excerpt,
    date: semana.data.date ? String(semana.data.date) : undefined,
    tags: semana.data.tags ?? [],
    raw: semana.body,
  };
});
---

<BaseLayout title={title} wideContent>
  <h1 class="text-center text-3xl font-bold mb-6 text-neon">Reportes Semanales</h1>
  
  <div id="semanas" class="space-y-6">
    <SemanaList client:idle semanas={semanasData} />
  </div>
</BaseLayout>
